@testset "MC: IsingModel Simulation" begin
    Random.seed!(123)
    m = IsingModel(dims=2, L=8);
    mc = MC(m, beta=0.35);
    run!(mc, sweeps=1000, thermalization=10, verbose=false);

    # Check measurements
    measured = measurements(mc)
    @test   25.47  ≈ measured[:Magn].M |> mean         atol=0.01
    @test    0.82  ≈ measured[:Magn].M |> std_error    atol=0.01
    @test  887.    ≈ measured[:Magn].M2 |> mean        atol=1.0
    @test   46.    ≈ measured[:Magn].M2 |> std_error   atol=1.0
    @test    0.398 ≈ measured[:Magn].m |> mean         atol=0.001
    @test    0.013 ≈ measured[:Magn].m |> std_error    atol=0.001
    @test    1.300 ≈ measured[:Magn].chi |> mean       atol=0.001

    @test  -59.10  ≈ measured[:Energy].E |> mean       atol=0.01
    @test    0.88  ≈ measured[:Energy].E |> std_error  atol=0.01
    @test 3799.    ≈ measured[:Energy].E2 |> mean      atol=1.0
    @test  111.    ≈ measured[:Energy].E2 |> std_error atol=1.0
    @test   -0.924 ≈ measured[:Energy].e |> mean       atol=0.001
    @test    0.014 ≈ measured[:Energy].e |> std_error  atol=0.001
    @test    0.585 ≈ measured[:Energy].C |> mean       atol=0.001

    @test isempty(mc.configs) == true
end


@testset "DQMC: attractive HubbardModel Simulation" begin
    Random.seed!(123)
    m = HubbardModelAttractive(dims=2, L=4);
    N = 4*4
    mc = DQMC(m, beta=1.0);
    mask = DistanceMask(lattice(m))
    MonteCarlo.unsafe_push!(mc, :CDC => ChargeDensityCorrelationMeasurement(mc, m, mask=mask))
    MonteCarlo.unsafe_push!(mc, :SDC => SpinDensityCorrelationMeasurement(mc, m, mask=mask))
    MonteCarlo.unsafe_push!(mc, :PC => PairingCorrelationMeasurement(mc, m, mask=mask))
    run!(mc, sweeps=1000, thermalization=10, verbose=false);

    # Check measurements

    # Greens

    measured = measurements(mc)
    @test [
        0.477228 -0.148092 0.000650671 -0.152739 -0.156428 0.0050096 0.0343558 0.00164354 0.000686254 0.0314209 -0.00315709 0.0363441 -0.149735 9.70741e-5 0.0335553 0.00358477; -0.153774 0.454577 -0.160642 0.000648542 0.0126497 -0.159687 0.00669076 0.0333576 0.037061 0.00569243 0.0358175 -0.00404491 0.00355269 -0.16096 0.0045801 0.0340806; 0.00137329 -0.149875 0.525756 -0.156449 0.0352624 0.000278655 -0.152092 -0.00291045 0.000989166 0.0322977 -0.00177604 0.0358907 0.0322688 -0.00133419 -0.151118 0.00029095; -0.145036 0.000208847 -0.148504 0.520469 0.00232344 0.0322997 -0.00403395 -0.141013 0.0340725 -0.00152847 0.0315167 -0.0043278 -0.0022816 0.032141 -0.00106526 -0.149073; -0.153225 0.0116195 0.0344808 0.00197823 0.459859 -0.154248 0.00721501 -0.148024 -0.157576 0.00551732 0.0349254 0.00233362 0.00219748 0.0371333 -0.00627411 0.03385; 0.00507538 -0.151558 -0.000391151 0.0329975 -0.155022 0.479573 -0.150905 0.00226697 0.00295499 -0.148607 0.00301816 0.0347823 0.0315428 0.00392446 0.0326532 -0.00249034; 0.0351943 0.00306724 -0.159841 -0.00715043 0.00575413 -0.155764 0.491007 -0.148957 0.0353336 0.00576441 -0.153046 -0.00141562 -0.000898893 0.0362212 0.00138285 0.0337357; 0.00118721 0.0348373 -0.00172386 -0.166127 -0.168602 0.000460718 -0.16182 0.508259 -0.000832228 0.036381 0.000702338 -0.165049 0.0363685 0.000530091 0.0375223 3.16583e-7; -0.000531546 0.031598 0.000765815 0.0349322 -0.150373 0.00357689 0.032698 -0.00108294 0.507991 -0.14935 0.00185427 -0.154108 -0.147832 -0.00104978 0.032203 -0.000816359; 0.0354625 0.00767388 0.0356703 0.000856574 0.00576076 -0.152291 0.0023841 0.0328979 -0.157559 0.475779 -0.156894 -0.00115001 -0.00177241 -0.158056 0.00557598 0.0338655; -0.00215687 0.0327828 -0.00226684 0.0351669 0.0352777 0.00517752 -0.149678 -0.000851672 0.00202061 -0.151299 0.480858 -0.157663 0.0346624 6.83759e-5 -0.155145 0.000856897; 0.0346939 -0.00253293 0.0333441 -0.00604537 -0.000972427 0.034324 -0.000290598 -0.147195 -0.160874 -0.00191725 -0.157674 0.52118 -0.00359494 0.0360121 0.00140374 -0.153626; -0.156798 0.00415648 0.0344931 -0.00219987 0.00366139 0.0365817 -0.00100057 0.0324253 -0.163216 -0.00268529 0.0365863 -0.00464487 0.526158 -0.162021 0.00374309 -0.151599; -0.000494114 -0.148824 -0.00554303 0.0321295 0.0336398 0.00246292 0.0314112 -0.00022372 -0.00163466 -0.149309 0.00169644 0.0332757 -0.149364 0.494472 -0.146979 -0.001565; 0.0343884 0.00516688 -0.153669 -0.00249342 -0.00596883 0.0360426 0.00222142 0.0311754 0.0350533 0.00385871 -0.154668 0.00290686 4.46472e-5 -0.155343 0.498268 -0.146554; 0.00117938 0.0336081 0.000884403 -0.159131 0.0366746 -0.00326657 0.0348769 0.00402202 -0.00051693 0.0347719 0.00395268 -0.160173 -0.154205 0.000746075 -0.154492 0.47354
    ] ≈ measured[:Greens].obs |> mean           atol=0.0001
    @test [
        0.0205191 0.00466986 0.00319713 0.00433101 0.0063448 0.00298264 0.00188447 0.00270596 0.00279388 0.00147149 0.00223948 0.00191749 0.00544694 0.0034801 0.00166324 0.00279062; 0.00581179 0.0173809 0.00615989 0.00298333 0.00264239 0.00544051 0.00288374 0.00180361 0.00208151 0.00286832 0.0019582 0.0017646 0.00267498 0.00597742 0.00256961 0.00180452; 0.00304324 0.00535371 0.0171345 0.00603167 0.00188977 0.00215002 0.00496448 0.00224604 0.0019083 0.00161783 0.00226727 0.00188134 0.00147511 0.00266665 0.00549195 0.00243711; 0.00409947 0.00231981 0.00510606 0.0172372 0.00209903 0.00155016 0.00232761 0.00370052 0.0018203 0.00180111 0.00127228 0.00238768 0.00236927 0.00137936 0.00228196 0.00505507; 0.0059045 0.0025362 0.00187802 0.00270614 0.0191752 0.00584846 0.00234163 0.00566209 0.00677845 0.00217692 0.001687 0.00235139 0.00203264 0.00186346 0.00162346 0.00230803; 0.00271169 0.00545808 0.00263302 0.0016385 0.00582896 0.0177921 0.00586849 0.00208916 0.00277508 0.00461105 0.00264704 0.00144147 0.00176448 0.00242271 0.0019095 0.00155428; 0.00196409 0.00206585 0.00588655 0.00288169 0.00244775 0.00538384 0.0147285 0.00616923 0.00185163 0.00234098 0.00470289 0.00209398 0.00170172 0.00177406 0.00201058 0.00195253; 0.00291793 0.00171317 0.00288986 0.00509084 0.00732493 0.00205185 0.00623073 0.0158797 0.00265401 0.00204915 0.00334973 0.00524786 0.00180304 0.00206516 0.00213687 0.00277024; 0.00228005 0.00158917 0.00184363 0.00168331 0.00600594 0.0023704 0.00159086 0.00215774 0.0179357 0.00458805 0.00265191 0.0057394 0.0048724 0.00230553 0.00160043 0.00256597; 0.00188113 0.00260856 0.00165067 0.00188637 0.00246927 0.00535851 0.00277197 0.00174793 0.00452975 0.0186795 0.00587128 0.00293908 0.00256491 0.00550431 0.00254789 0.00182041; 0.00199224 0.00198167 0.00239671 0.00148865 0.0019963 0.00225782 0.0048999 0.00253693 0.00227267 0.00495478 0.0167915 0.00544362 0.00193831 0.00261395 0.00605124 0.00213894; 0.00201428 0.00189837 0.00177325 0.00217569 0.00219486 0.00157229 0.00262323 0.00533245 0.00639645 0.00236338 0.00582814 0.0141972 0.00214637 0.00170952 0.00242774 0.00652343; 0.00551784 0.00314772 0.0018408 0.00244508 0.00239146 0.00211826 0.00165435 0.00167652 0.00526101 0.00247197 0.00198295 0.00232103 0.0166794 0.00479359 0.00235695 0.0051415; 0.00299558 0.00716651 0.00302339 0.00157788 0.00177353 0.00249744 0.00176033 0.00164171 0.00242951 0.00543594 0.00212568 0.00147208 0.00535451 0.0167751 0.00525319 0.00226052; 0.00194073 0.0021867 0.00667736 0.00247544 0.00198623 0.00230368 0.00222494 0.00156614 0.00178054 0.00234639 0.00585425 0.00259014 0.00238915 0.00565968 0.0169088 0.00539021; 0.00288388 0.00177993 0.00292207 0.00446213 0.00215593 0.00206059 0.00171043 0.00265896 0.00261172 0.00179292 0.00246213 0.00612522 0.00551238 0.00288897 0.00570215 0.0156827
    ] ≈ measured[:Greens].obs |> std_error      atol=0.0001

    # Boson Energy

    @test  0.784 ≈ measured[:BosonEnergy].obs |> mean           atol=0.001
    @test  0.430 ≈ measured[:BosonEnergy].obs |> std_error      atol=0.001

    # Configurations :conf

    @test [
        0.16 -0.06 0.1 0.04 0.16 -0.1 -0.06 0.16 0.04 0.0; -0.04 0.1 0.14 0.16 0.22 0.32 0.06 0.12 0.06 -2.22045e-18; -0.16 0.14 -0.1 -0.02 0.02 0.1 -0.22 -0.16 -0.04 -0.08; 0.04 -0.06 -0.08 -0.06 -0.08 -0.16 -0.08 -0.1 -0.04 0.06; 0.1 0.12 0.14 0.18 0.14 0.08 -2.22045e-18 0.18 -0.02 0.04; 0.22 0.04 0.22 -0.16 0.04 -0.08 -0.04 0.06 0.12 9.99201e-18; -0.08 0.06 0.16 0.08 0.04 -0.06 -0.08 0.18 0.0 -0.04; -0.2 0.04 0.0 0.06 -0.06 0.04 -2.10942e-17 -0.06 0.18 -0.16; -0.1 0.06 0.1 -0.12 -0.08 0.08 -8.88178e-18 -0.12 -0.08 0.1; 0.16 -0.04 0.06 -0.02 -0.1 0.1 0.16 -0.06 0.16 0.04; 0.08 0.1 -0.12 0.06 -0.06 0.2 0.06 -0.06 0.04 0.04; 0.08 -0.2 -0.04 -0.02 -0.12 -0.08 -0.1 0.14 -0.14 -0.02; -0.06 -0.1 -0.02 0.06 -0.08 -0.08 -0.02 0.1 -0.14 -0.16; 0.1 -0.08 -0.08 0.12 0.04 -0.02 -0.22 0.08 -0.06 0.12; -0.16 0.04 0.16 0.12 0.08 0.1 0.22 -0.16 -0.12 -0.02; -2.22045e-18 0.06 0.02 0.04 0.1 0.06 0.22 0.16 -0.06 -0.02
        ] ≈ [MonteCarlo.decompress(mc, m, c) for c in mc.configs] |> mean                    atol=0.01
    @test MonteCarlo.decompress(mc, m, mc.configs[end]) == mc.conf

    # Charge Density Correlation

    @test [
        1.5849456448588939 0.9701001185866102 1.0244814820688672 1.022266129934798; 0.9697846981453444 1.0275337295377804 1.026623185263297 1.0223883386970969; 0.9701001185866102 1.0293074250579948 1.0293074250579948 1.0223883386970969; 0.9697846981453444 1.026623185263297 1.0222661299347977 1.0303491969344496
    ][:] ≈ mean(measured[:CDC])
    @test [
        0.014339182796261328 0.015103839236855635 0.014881366201547199 0.014852492590291122; 0.01466075859047431 0.0146316314779252 0.015350965765936066 0.015454398305087881; 0.015103839236855635 0.013429158101512143 0.013429158101512805 0.015454398305088025; 0.014660758590474386 0.0153509657659365 0.014852492590291273 0.014691107761383475
    ][:] ≈ std_error(measured[:CDC])

    # Spin density correlations (x, y, z)

    @test [
        0.4413107278403039 -0.043536617096963874 -0.0009168475990912314 -0.002016368338663856; -0.04345933389844916 -0.0009282194533560656 -0.0009516994871196575 -0.0020119947928066984; -0.043536617096963874 -0.0009264768513716855 -0.0009264768513716858 -0.002011994792806698; -0.04345933389844915 -0.0009516994871196575 -0.002016368338663856 -0.0005286346557753946
    ][:] ≈ mean(measured[:SDC].x)
    @test [
        0.0016150660150651 0.00023159307395462136 5.630998807076127e-5 2.734317071034562e-5; 0.00026936524556120796 5.410748862202873e-5 3.4723053809401575e-5 2.429688372763204e-5; 0.00023159307395462136 2.793103304288827e-5 2.7931033042888085e-5 2.429688372763204e-5; 0.00026936524556119993 3.4723053809401575e-5 2.7343170710346242e-5 3.227352872694644e-5
    ][:] ≈ std_error(measured[:SDC].x)
    @test [
        0.4413107278403039 -0.043536617096963874 -0.0009168475990912314 -0.002016368338663856; -0.04345933389844916 -0.0009282194533560656 -0.0009516994871196575 -0.0020119947928066984; -0.043536617096963874 -0.0009264768513716855 -0.0009264768513716858 -0.002011994792806698; -0.04345933389844915 -0.0009516994871196575 -0.002016368338663856 -0.0005286346557753946
    ][:] ≈ mean(measured[:SDC].y)
    @test [
        0.0016150660150651 0.00023159307395462136 5.630998807076127e-5 2.734317071034562e-5; 0.00026936524556120796 5.410748862202873e-5 3.4723053809401575e-5 2.429688372763204e-5; 0.00023159307395462136 2.793103304288827e-5 2.7931033042888085e-5 2.429688372763204e-5; 0.00026936524556119993 3.4723053809401575e-5 2.7343170710346242e-5 3.227352872694644e-5
    ][:] ≈ std_error(measured[:SDC].y)
    @test [
        0.4413107278403039 -0.043536617096963874 -0.0009168475990912304 -0.002016368338663856; -0.04345933389844916 -0.0009282194533560664 -0.0009516994871196569 -0.0020119947928066966; -0.043536617096963874 -0.0009264768513716854 -0.0009264768513716854 -0.002011994792806697; -0.04345933389844915 -0.0009516994871196569 -0.0020163683386638562 -0.0005286346557753948
    ][:] ≈ mean(measured[:SDC].z)
    @test [
        0.0016150660150651 0.00023159307395463074 5.6309988070761405e-5 2.734317071034562e-5; 0.00026936524556119993 5.410748862202873e-5 3.4723053809401765e-5 2.429688372763239e-5; 0.0002315930739546401 2.793103304288835e-5 2.793103304288846e-5 2.4296883727631342e-5; 0.00026936524556119993 3.472305380940155e-5 2.734317071034562e-5 3.2273528726946354e-5
    ][:] ≈ std_error(measured[:SDC].z)

    # Pairing Correlations
    @test [
        0.3900138179258347, 0.3385201904724836, 0.33805131570116004, 0.33852019047248355, 0.33805131570116, 0.3432823067237546, 0.34352013129613496, 0.3429887666591009, 0.3433585499968336, 0.3429887666591008, 0.3435201312961349, 0.34243257395556, 0.34243257395556, 0.34230492985434835, 0.34230492985434835, 0.34492187005856595
    ] ≈ mean(measured[:PC])
    @test [
        0.003577038170231938, 0.0035490236425759734, 0.003640681043456678, 0.0035490236425759734, 0.00364068104345664, 0.0037002913257043082, 0.003922603954962933, 0.003585060603100492, 0.003888811724031418, 0.003585060603100531, 0.0039226039549626855, 0.0036070092345573124, 0.0036070092345572738, 0.0035380018673369018, 0.0035380018673369018, 0.0037163372746808984
    ] ≈ std_error(measured[:PC])
end



@testset "DQMC: repulsive HubbardModel Simulation" begin
    Random.seed!(123)
    m = HubbardModelRepulsive(dims=2, L=2);
    mc = DQMC(m, beta=1.0);
    mask = DistanceMask(lattice(m))
    MonteCarlo.unsafe_push!(mc, :M => MagnetizationMeasurement(mc, m))
    MonteCarlo.unsafe_push!(mc, :CDC => ChargeDensityCorrelationMeasurement(mc, m, mask=mask))
    MonteCarlo.unsafe_push!(mc, :SDC => SpinDensityCorrelationMeasurement(mc, m, mask=mask))
    MonteCarlo.unsafe_push!(mc, :PC => PairingCorrelationMeasurement(mc, m, mask=mask))
    run!(mc, sweeps=1000, thermalization=10, verbose=false);

    # Check measurements
    measured = measurements(mc)

    # Greens
    @test [
        0.5230841929541843 -0.24580190394819287 -0.24353625126427442 0.004793235750642132 2.4747881310481137e-16 -3.1027820349620315e-16 7.391748537089951e-17 -2.5831301570682258e-17; -0.23337037385181028 0.46967433733205316 0.013610778813472314 -0.24084716318640784 -8.750483476358716e-17 1.7993237681827342e-16 -6.178032631496232e-17 -4.866665029973933e-18; -0.23685341419748945 0.005966740755167903 0.4503815764207921 -0.2479025996196592 -1.363766865323684e-16 1.7580521739347312e-16 -2.8861255234634915e-17 8.969676585036754e-18; 0.0034393763662858546 -0.23649252185732803 -0.2316584856751386 0.5240047156724452 2.6940842904323674e-17 -4.5315575868456136e-17 1.2857219650695361e-17 -2.045675489460436e-17; -1.1933650703402011e-17 -1.143143885417272e-17 4.92560332867809e-18 3.652108436053344e-18 0.4769158070458147 -0.23337037385181056 -0.23685341419748962 -0.0034393763662852817; 4.695172892856388e-18 1.4031001247466892e-17 -3.660193161833258e-18 -7.181060269264664e-18 -0.24580190394819268 0.5303256626679477 -0.005966740755167636 -0.23649252185732744; 5.0858535409850376e-18 3.481044858895411e-18 7.064468561930262e-18 -9.582780353138076e-18 -0.2435362512642741 -0.013610778813472 0.5496184235792082 -0.23165848567513814; 4.252533790177161e-18 -4.150667709361308e-18 -9.165073498114988e-18 4.441452577704451e-18 -0.004793235750641649 -0.2408471631864082 -0.24790259961965982 0.4759952843275548
    ] ≈ measured[:Greens].obs |> mean           atol=0.0001
    @test [
        0.013739983783213679 0.006492383160048527 0.007868166257888703 0.007011599433902677 1.6371492330947007e-16 1.6895171942421666e-16 1.3147713438583098e-16 1.741991342685165e-16; 0.0067046975595375854 0.014363246104568633 0.007009979794310533 0.006051719092939807 1.0350643125273229e-16 1.2990285472829452e-16 9.03303691512482e-17 1.1406644150330444e-16; 0.006597825955961891 0.006909577363813027 0.014480278026596427 0.007734651000791531 8.312635141518536e-17 9.627695667394742e-17 7.463707227745457e-17 9.277591280283248e-17; 0.006452512754932946 0.006407099317999007 0.005547394403978844 0.013834977867382078 6.072279899847821e-17 5.5474009445331095e-17 5.58424813603294e-17 6.450100293405204e-17; 1.1688795318424512e-17 1.1065873105400382e-17 1.0498821098538937e-17 1.0574872897964097e-17 0.013739983783213618 0.006704697559537689 0.006597825955961944 0.006452512754932903; 1.2642432560141777e-17 1.1459393142803876e-17 1.1730533470603598e-17 1.3804242444868925e-17 0.006492383160048495 0.014363246104568825 0.0069095773638130345 0.006407099317998975; 1.0260271606226589e-17 9.835267098871163e-18 1.1811925523273703e-17 1.3415958666800159e-17 0.007868166257888711 0.007009979794310522 0.014480278026596368 0.005547394403978744; 1.1196670079817317e-17 1.1626921359631006e-17 9.630823465522755e-18 1.3020502031907809e-17 0.007011599433902663 0.006051719092939749 0.007734651000791531 0.013834977867382038
    ] ≈ measured[:Greens].obs |> std_error      atol=0.0001

    # Boson Energy
    @test  0.0 == measured[:BosonEnergy].obs |> mean
    @test  0.0 == measured[:BosonEnergy].obs |> std_error

    # Configurations :conf
    @test [
        0.06 -0.18 0.0 0.24 0.1 -0.22 -0.02 -0.18 0.02 -0.08; 0.24 0.06 -0.08 0.08 -0.12 -0.16 -0.12 0.16 0.06 0.18; 0.16 -0.02 0.1 0.16 0.16 0.08 -0.08 0.14 0.16 0.22; 0.08 0.08 0.16 -0.06 -0.04 -0.2 -0.1 0.14 -0.26 -0.02
    ] ≈ [MonteCarlo.decompress(mc, m, c) for c in mc.configs] |> mean                    atol=0.01
    @test MonteCarlo.decompress(mc, m, mc.configs[end]) == mc.conf

    # Charge Density Correlation
    @test [
        1.4566330702285535, 0.8922305372281553, 0.8919439885568281, 0.9917464772099726
    ][:] ≈ mean(measured[:CDC])
    @test [
        0.0026782692043020697, 0.00099655437705915, 0.0010896507507328099, 0.0007703322144962636
    ][:] ≈ std_error(measured[:CDC])

    # Magnetization
    @test [
        -2.355451624014094e-16, -1.9396337806574036e-16, 2.1796786672704633e-17, 1.6015302316899927e-17
    ] ≈ mean(measured[:M].x)        atol=1e-14
    @test [
        1.656175115237972e-16, 1.3043830171432643e-16, 7.764376762927484e-17, 6.657122636316582e-17
    ] ≈ std_error(measured[:M].x)   atol=1e-14
    @test [
        -2.5941246380821326e-16 + 0.0im, -1.6590137557080656e-16 + 0.0im, 3.5925723796565145e-17 + 0.0im, 2.489820747230881e-17 + 0.0im
    ] ≈ mean(measured[:M].y)        atol=1e-14
    @test [
        1.6263224765435753e-16, 1.3037633282695832e-16, 7.342937854677689e-17, 6.502382275618026e-17
    ] ≈ std_error(measured[:M].y)   atol=1e-14
    @test [
        -0.04616838590836951, 0.06065132533589437, 0.09923684715841624, -0.04800943134489042
    ] ≈ mean(measured[:M].z)
    @test [
        0.02747996756642731, 0.028726492209137387, 0.02896055605319296, 0.02766995573476392
    ] ≈ std_error(measured[:M].z)

    # Spin density correlations (x, y, z)
    @test [
        0.5433669297714467, -0.12437171904169995, -0.12368172048269852, 0.009923485745788156
    ][:] ≈ mean(measured[:SDC].x)
    @test [
        0.0026782692042987537, 0.0022983340582912737, 0.002353490577061975, 0.0009641628066196104
    ][:] ≈ std_error(measured[:SDC].x)
    @test [
        0.5433669297714467, -0.12437171904169995, -0.12368172048269852, 0.009923485745788156
    ][:] ≈ mean(measured[:SDC].y)
    @test [
        0.0026782692042987537, 0.0022983340582912737, 0.002353490577061975, 0.0009641628066196104
    ][:] ≈ std_error(measured[:SDC].y)
    @test [
        0.5433669297714467, -0.1407248237886177, -0.13469528563459737, 0.021836355692197208
    ][:] ≈ mean(measured[:SDC].z)
    @test [
        0.0026782692042987537, 0.00685231704618611, 0.006880030290025915, 0.006018343758552928
    ][:] ≈ std_error(measured[:SDC].z)

    # Pairing Correlations
    @test [
        0.33210251082677134, 0.375745578970169, 0.37376750864460734, 0.3543658004894054
    ] ≈ mean(measured[:PC])
    @test [
        0.0019595261151014363, 0.0022538359059402486, 0.0023202521080692914, 0.0021325115102224725
    ] ≈ std_error(measured[:PC])
end



# TODO
# remove this / make this an example / make this faster
#=


"""
    stat_equal(
        expected_value, actual_values, standard_errors;
        min_error = 0.1^3, order=2, rtol = 0, debug=false
    )

Compare an `expected_value` (i.e. literature value, exact result, ...) to a set
of `actual_values` and `standard_errors` (i.e. calculated from DQMC or MC).

- `order = 2`: Sets the number of σ-intervals included. (This affects the
accuracy of the comaprison and the number of matches required)
- `min_error = 0.1^3`: Sets a lower bound for the standard error. (If one
standard error falls below `min_error`, `min_error` is used instead. This
happens before `order` is multiplied.)
- `rtol = 0`: The relative tolerance passed to `isapprox`.
- `debug = false`: If `debug = true` information on comparisons is always printed.
"""
function stat_equal(
        expected_value, actual_values::Vector, standard_errors::Vector;
        min_error = 0.001, order=2, debug=false, rtol=0.0
    )

    @assert order > 1
    N_matches = floor(length(actual_values) * (1 - 1 / order^2))
    if N_matches == 0
        error("No matches required. Try increasing the sample size or σ-Interval")
    elseif N_matches < 3
        @warn "Only $N_matches out of $(length(actual_values)) are required!"
    end

    is_approx_equal = [
        isapprox(expected_value, val, atol=order * max(min_error, err), rtol=rtol)
        for (val, err) in zip(actual_values, standard_errors)
    ]
    does_match = sum(is_approx_equal) >= N_matches

    if debug || !does_match
        printstyled("────────────────────────────────\n", color = :light_magenta)
        print("stat_equal returned ")
        printstyled("$(does_match)\n\n", color = does_match ? :green : :red)
        print("expected: $expected_value\n")
        print("values:   [")
        for i in eachindex(actual_values)
            if i < length(actual_values)
                printstyled("$(actual_values[i])", color = is_approx_equal[i] ? :green : :red)
                print(", ")
            else
                printstyled("$(actual_values[i])", color = is_approx_equal[i] ? :green : :red)
            end
        end
        print("]\n")
        print("$(order)-σ:      [")
        for i in eachindex(standard_errors)
            if i < length(standard_errors)
                printstyled("$(standard_errors[i])", color = is_approx_equal[i] ? :green : :red)
                print(", ")
            else
                printstyled("$(standard_errors[i])", color = is_approx_equal[i] ? :green : :red)
            end
        end
        print("]\n")
        print("checks:   [")
        for i in eachindex(standard_errors)
            if i < length(standard_errors)
                printstyled("$(is_approx_equal[i])", color = is_approx_equal[i] ? :green : :red)
                print(", ")
            else
                printstyled("$(is_approx_equal[i])", color = is_approx_equal[i] ? :green : :red)
            end
        end
        print("]\n")
        printstyled("────────────────────────────────\n", color = :light_magenta)
    end
    does_match
end



@testset "DQMC: triangular Hubbard model vs dos Santos Paper" begin
    # > Attractive Hubbard model on a triangular lattice
    # dos Santos
    # https://journals.aps.org/prb/abstract/10.1103/PhysRevB.48.3976
    Random.seed!()
    sample_size = 5

    @time for (k, (mu, lit_oc, lit_pc,  beta, L)) in enumerate([
            (-2.0, 0.12, 1.0,  5.0, 4),
            (-1.2, 0.48, 1.50, 5.0, 4),
            ( 0.0, 0.88, 0.95, 5.0, 4),
            ( 1.2, 1.25, 1.55, 5.0, 4),
            ( 2.0, 2.00, 0.0,  5.0, 4),

            # (-2.0, 0.12, 1.0,  8.0, 4),
            # (-1.2, 0.48, 1.82, 8.0, 4),
            # ( 0.0, 0.88, 0.95, 8.0, 4),
            # ( 1.2, 1.25, 1.65, 8.0, 4),
            # ( 2.0, 2.00, 0.0,  8.0, 4),

            # (-2.0, 0.40, 1.0,  5.0, 6),
            # (-1.2, 0.40, 1.05, 5.0, 6),
            # (0.01, 0.80, 1.75, 5.0, 6),
            # ( 1.2, 1.40, 2.0,  5.0, 6),
            # ( 2.0, 2.00, 0.0,  5.0, 6)
        ])
        @info "[$(k)/15] μ = $mu   L = $L   β = $beta (literature check)"
        m = HubbardModelAttractive(
            dims=2, L=L, l = MonteCarlo.TriangularLattice(L),
            t = 1.0, U = 4.0, mu = mu
        )
        OC_sample = []
        OC_errors = []
        PC_sample = []
        PC_errors = []
        for i in 1:sample_size
            mc = DQMC(
                m, beta=5.0, delta_tau=0.125, safe_mult=8,
                thermalization=2000, sweeps=2000, measure_rate=1,
                measurements = Dict{Symbol, MonteCarlo.AbstractMeasurement}()
            )
            push!(mc, :occ => MonteCarlo.OccupationMeasurement)
            push!(mc, :PC => MonteCarlo.PairingCorrelationMeasurement)
            run!(mc, verbose=false)
            measured = measurements(mc)

            # mean(measured[:G]) = MC mean
            # diag gets c_i c_i^† terms
            # 2 (1 - mean(c_i c_i^†)) = 2 mean(c_i^† c_i) where 2 follows from 2 spins
            occupation = 2 - 2(measured[:occ].obs |> mean |> mean)
            push!(OC_sample, occupation)
            push!(OC_errors, 2(measured[:occ].obs |> std_error |> mean))
            push!(PC_sample, measured[:PC] |> swave |> mean)
            push!(PC_errors, measured[:PC] |> swave |> std_error)
        end
        # min_error should compensate read-of errors & errors in the results
        # dos Santos used rather few sweeps, which seems to affect PC peaks strongly
        @info "Occupation"
        @test stat_equal(lit_oc, OC_sample, OC_errors, min_error=0.025)
        @info "Pairing Correlation"
        @test stat_equal(lit_pc, PC_sample, PC_errors, min_error=0.05)
    end
end

=#
